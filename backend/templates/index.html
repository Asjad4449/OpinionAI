<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpinionAI Debate</title>
  <script>
    let loadingInterval; // Global variable for loading animation

    async function submitOpinion(event) {
      event.preventDefault();
      let opinionInput = document.getElementById("opinionInput");
      let chatContainer = document.getElementById("chatContainer");
      let opinionHeader = document.getElementById("opinionHeader");

      let opinion = opinionInput.value.trim();
      if (opinion === "") return;

      // Display the opinion at the top
      opinionHeader.innerHTML = `<h2>Your Opinion:</h2><p>${opinion}</p>`;
      
      // Hide the input container
      document.getElementById("inputContainer").style.display = "none";

      // Show loading message with an id for animation
      chatContainer.innerHTML = `<div class="message loading" id="loadingMessage">Generating debate</div>`;
      
      // Start the loading animation
      startLoadingAnimation();

      try {
        let response = await fetch("/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ opinion: opinion })
        });

        let data = await response.json();
        console.log("Received data:", data);
        
        // Store debate data globally with the topic
        window.currentDebate = {
          ...data,
          topic: opinion  // Add the opinion as the topic
        };

        // Stop and remove the loading message
        clearInterval(loadingInterval);
        let loadingMsg = document.getElementById("loadingMessage");
        if (loadingMsg) loadingMsg.remove();

        // Clear chat container before displaying debate messages
        chatContainer.innerHTML = "";

        // Build an array of debate messages interleaving for and against
        let debateMessages = [];
        let maxLength = Math.max(data.pros.length, data.cons.length);
        for (let i = 0; i < maxLength; i++) {
          if (data.pros[i]) {
            debateMessages.push({ type: "for", argument: data.pros[i].argument });
          }
          if (data.cons[i]) {
            debateMessages.push({ type: "against", argument: data.cons[i].argument });
          }
        }

        // Display messages one at a time with a 2-second delay and smooth scrolling
        let currentIndex = 0;
        let intervalId = setInterval(() => {
          if (currentIndex < debateMessages.length) {
            let msg = debateMessages[currentIndex];
            let containerClass = msg.type === "for" ? "debate-container" : "debate-container right-align";
            let messageClass = msg.type === "for" ? "message for fade-in" : "message against fade-in";
            chatContainer.insertAdjacentHTML('beforeend', `
              <div class="${containerClass}">
                <div class="${messageClass}">${msg.argument}</div>
              </div>
            `);
            currentIndex++;
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
          } else {
            clearInterval(intervalId);
            // After all messages, append the sources and images sections
            appendSources(data.sources);
          }
        }, 2000);
      } catch (error) {
        console.error("Error fetching debate:", error);
      }
    }

    function startLoadingAnimation() {
      let loadingElement = document.getElementById("loadingMessage");
      let dots = 0;
      loadingInterval = setInterval(() => {
        dots = (dots + 1) % 4; // cycles: 0, 1, 2, 3
        let dotStr = ".".repeat(dots);
        loadingElement.innerText = "Generating debate" + dotStr;
      }, 500);
    }

    function appendSources(sourcesData) {
      let chatContainer = document.getElementById("chatContainer");
      let sourcesHTML = `
        <div id="sourcesSection">
          <div class="buttons-container">
            <button id="sourcesToggle" onclick="toggleSources()">Sources ⬇</button>
            <button id="sentimentToggle" onclick="toggleSentimentAnalysis()">Sentiment Analysis ⬇</button>
            <button id="socialToggle" onclick="toggleSocialAnalysis()">Social Analysis ⬇</button>
          </div>
          <div id="sourcesDropdown" class="hidden">
      `;
      sourcesData.forEach((sourceList, index) => {
        sourcesHTML += `<p><b>Point ${index + 1} Sources:</b></p>`;
        if (Array.isArray(sourceList) && sourceList.length > 0) {
          sourceList.forEach(source => {
            sourcesHTML += `<p><a href="${source[1]}" target="_blank">${source[0]}</a></p>`;
          });
        }
      });
      sourcesHTML += `</div></div>`;
      chatContainer.insertAdjacentHTML('beforeend', sourcesHTML);

      // Add the sentiment analysis container (hidden by default)
      chatContainer.insertAdjacentHTML('beforeend', `
        <div id="sentimentSection">
          <div id="sentimentContainer" class="hidden">
            <div class="analysis-results">
              <h3>Debate Analysis Results</h3>
              <div id="proResults" class="side-results">
                <h4>Pro Side</h4>
                <div class="metrics"></div>
              </div>
              <div id="conResults" class="side-results">
                <h4>Con Side</h4>
                <div class="metrics"></div>
              </div>
              <div id="conclusion" class="conclusion"></div>
            </div>
            <div class="graph-grid">
              <div class="graph-container">
                <img id="graph1" alt="Key Metrics" />
              </div>
              <div class="graph-container">
                <img id="graph2" alt="Composite Scores" />
              </div>
              <div class="graph-container">
                <img id="graph3" alt="Sentiment Radar" />
              </div>
            </div>
          </div>
        </div>
      `);

      // Add the social analysis container after sentiment container
      chatContainer.insertAdjacentHTML('beforeend', `
        <div id="socialSection">
          <div id="socialContainer" class="hidden">
            <div class="social-analysis">
                <h3>Social Media Analysis</h3>
                <div class="analysis-content">
                    <div class="sentiment-section">
                        <h4>Overall Social Sentiment</h4>
                        <div class="sentiment-badge" id="socialSentiment"></div>
                    </div>
                    <div class="key-points-section">
                        <h4>Key Discussion Points</h4>
                        <div class="points-grid" id="keyPoints"></div>
                    </div>
                    <div class="platform-section">
                        <h4>Platform Insights</h4>
                        <div class="insights-box" id="platformInsights"></div>
                    </div>
                </div>
            </div>
          </div>
        </div>
      `);

      chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
    }

    function toggleSources() {
      let sourcesDropdown = document.getElementById("sourcesDropdown");
      let sourcesToggle = document.getElementById("sourcesToggle");
      let sentimentContainer = document.getElementById("sentimentContainer");
      let sentimentToggle = document.getElementById("sentimentToggle");
      let socialContainer = document.getElementById("socialContainer");
      let socialToggle = document.getElementById("socialToggle");

      // Close sentiment analysis if open
      if (sentimentContainer.style.display === "block") {
        sentimentContainer.style.display = "none";
        sentimentToggle.innerHTML = "Sentiment Analysis ⬇";
      }

      // Toggle sources
      if (sourcesDropdown.style.display === "none" || sourcesDropdown.style.display === "") {
        sourcesDropdown.style.display = "block";
        sourcesToggle.innerHTML = "Sources ⬆";
      } else {
        sourcesDropdown.style.display = "none";
        sourcesToggle.innerHTML = "Sources ⬇";
      }

      // Close social analysis if open
      if (socialContainer.style.display === "block") {
        socialContainer.style.display = "none";
        socialToggle.innerHTML = "Social Analysis ⬇";
      }
    }

    async function toggleSentimentAnalysis() {
      let sentimentContainer = document.getElementById("sentimentContainer");
      let toggleButton = document.getElementById("sentimentToggle");
      let sourcesDropdown = document.getElementById("sourcesDropdown");
      let sourcesToggle = document.getElementById("sourcesToggle");
      let socialContainer = document.getElementById("socialContainer");
      let socialToggle = document.getElementById("socialToggle");

      // Close other containers if open
      if (sourcesDropdown.style.display === "block") {
        sourcesDropdown.style.display = "none";
        sourcesToggle.innerHTML = "Sources ⬇";
      }
      if (socialContainer.style.display === "block") {
        socialContainer.style.display = "none";
        socialToggle.innerHTML = "Social Analysis ⬇";
      }

      if (sentimentContainer.style.display === "none" || sentimentContainer.style.display === "") {
        sentimentContainer.style.display = "block";
        toggleButton.innerHTML = "Sentiment Analysis ⬆";
        
        try {
          const response = await fetch("/sentiment_analysis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(window.currentDebate)
          });
          
          const data = await response.json();
          
          // Check if we have valid data before updating
          if (data && data.graphs && Array.isArray(data.graphs)) {
            // Update the graphs
            document.getElementById("graph1").src = data.graphs[0] || '';
            document.getElementById("graph2").src = data.graphs[1] || '';
            document.getElementById("graph3").src = data.graphs[2] || '';

            // Update analysis results
            if (data.analysis) {
              // Update Pro side metrics
              const proMetrics = document.querySelector("#proResults .metrics");
              proMetrics.innerHTML = formatMetrics(data.analysis["Pro Side"]);
              
              // Update Con side metrics
              const conMetrics = document.querySelector("#conResults .metrics");
              conMetrics.innerHTML = formatMetrics(data.analysis["Con Side"]);
              
              // Update conclusion
              const conclusion = document.getElementById("conclusion");
              conclusion.innerHTML = `
                <h4>Conclusion</h4>
                <p>${formatConclusion(data.analysis)}</p>
              `;
            }
          } else {
            console.error("Invalid response format:", data);
          }
        } catch (error) {
          console.error("Error generating sentiment analysis:", error);
          // Show error message to user
          document.getElementById("conclusion").innerHTML = `
            <h4>Error</h4>
            <p>Failed to generate sentiment analysis. Please try again.</p>
          `;
        }
      } else {
        sentimentContainer.style.display = "none";
        toggleButton.innerHTML = "Sentiment Analysis ⬇";
      }
    }

    function formatMetrics(sideData) {
      return `
        <div>Sentiment Score: ${sideData["Sentiment Score"]}</div>
        <div>Emotional Intensity: ${sideData["Emotional Intensity"]}</div>
        <div>Expert References: ${sideData["Expert References"]}</div>
        <div>Practical Appeals: ${sideData["Practical Appeals"]}</div>
        <div>Consistency Score: ${sideData["Consistency Score"]}</div>
        <div>Counter-argument Engagement: ${sideData["Counter-argument Engagement"]}</div>
      `;
    }

    function formatConclusion(analysis) {
      const proScore = analysis["Pro Side"]["Composite Score"];
      const conScore = analysis["Con Side"]["Composite Score"];
      const winner = proScore > conScore ? "Pro side" : "Con side";
      const margin = Math.abs(proScore - conScore);
      const strength = margin > 0.1 ? "significantly" : margin > 0.05 ? "moderately" : "marginally";
      
      return `The ${winner} presents ${strength} stronger arguments (${proScore} vs ${conScore} composite score).`;
    }

    async function toggleSocialAnalysis() {
      let socialContainer = document.getElementById("socialContainer");
      let toggleButton = document.getElementById("socialToggle");

      if (socialContainer.style.display === "none" || socialContainer.style.display === "") {
        socialContainer.style.display = "block";
        toggleButton.innerHTML = "Social Analysis ⬆";
        
        try {
          if (!window.currentDebate || !window.currentDebate.topic) {
            throw new Error("No debate topic available");
          }

          console.log("Current debate data:", window.currentDebate);
          const requestData = { topic: window.currentDebate.topic };
          console.log("Sending request data:", requestData);
          
          const response = await fetch("/social_analysis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData)
          });
          
          const data = await response.json();
          console.log("Received response:", data);
          
          if (data.success && data.data) {
            // Update sentiment with color
            const sentimentEl = document.getElementById("socialSentiment");
            sentimentEl.textContent = data.data.sentiment;
            // Add color based on sentiment
            sentimentEl.className = 'sentiment-badge ' + data.data.sentiment.toLowerCase();
            
            // Update key points with grid layout
            const keyPointsList = document.getElementById("keyPoints");
            keyPointsList.innerHTML = data.data.key_points
                .map(point => `<li>${point}</li>`)
                .join('');
            
            // Update platform insights
            document.getElementById("platformInsights").textContent = data.data.platform_insights;
          } else {
            document.querySelector(".analysis-content").innerHTML = `
                <div class="error-message">
                    Failed to analyze social media impact: ${data.error || 'Unknown error'}
                </div>
            `;
          }
        } catch (error) {
          console.error("Error in social analysis:", error);
          document.querySelector(".analysis-content").innerHTML = `
                <div class="error-message">
                    An error occurred while analyzing social media impact.
                </div>
            `;
        }
      } else {
        socialContainer.style.display = "none";
        toggleButton.innerHTML = "Social Analysis ⬇";
      }
    }

    function handleImageClick(imageNumber) {
      alert(`Image ${imageNumber} clicked!`);
      // You can add more functionality here based on which image is clicked
    }

    function resetDebate() {
      document.getElementById("opinionHeader").innerHTML = "";
      document.getElementById("chatContainer").innerHTML = "";
      document.getElementById("inputContainer").style.display = "flex";
      document.getElementById("opinionInput").value = "";
    }
  </script>
  <style>
    /* Fade-in Animation */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .fade-in {
      animation: fadeIn 0.75s ease;
    }

    /* General Styling */
    body { 
      font-family: Arial, sans-serif; 
      background: #343541; 
      color: white;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      height: 100vh;
      padding: 20px;
      position: relative;
    }
    h1 {
      font-size: 36px;
      font-weight: bold;
    }
    #opinionHeader {
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      max-width: 90%;
    }
    /* Key in the top-right corner */
    #key {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #222325;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
    #key span {
      display: block;
      margin-bottom: 5px;
    }
    /* Chat Window */
    #chatContainer { 
      width: 80%;
      height: 70vh;
      overflow-y: auto; 
      background: #444654; 
      padding: 25px; 
      border-radius: 12px; 
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .message { 
      padding: 20px;
      margin: 12px 0; 
      border-radius: 12px; 
      max-width: 65%;
      font-size: 20px;
      line-height: 1.6;
      color: white;
    }
    .debate-container {
      display: flex;
      justify-content: flex-start; 
      width: 100%;
    }
    .right-align {
      justify-content: flex-end;
    }
    .for { 
      background: #0d6efd;
      text-align: left;
      margin-right: auto;
    }
    .against { 
      background: #dc3545;
      text-align: right;
      margin-left: auto;
    }
    /* Sources and Images Buttons */
    #sourcesSection, #sentimentSection, #socialSection {
      margin-top: 20px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .buttons-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    #sourcesToggle, #sentimentToggle, #socialToggle {
      background: #0d6efd;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      margin-bottom: 10px;
      flex: 0 0 auto; /* Prevent buttons from stretching */
    }
    #sentimentToggle {
      background: #28a745; /* Green color for the Sentiment button */
    }
    #socialToggle {
      background: #6f42c1; /* Purple color for the Social button */
    }
    #sourcesToggle:hover, #sentimentToggle:hover, #socialToggle:hover {
      opacity: 0.9;
    }
    /* Sources Dropdown */
    #sourcesDropdown {
      background: #222325;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      width: fit-content;
      max-width: 75%;
      min-width: 300px;
      display: none;
      margin: 0 auto;
    }
    #sourcesDropdown p {
      margin: 8px 0;
      font-size: 18px;
      word-wrap: break-word; /* Ensures long words/URLs don't overflow */
      overflow-wrap: break-word;
    }
    #sourcesDropdown a {
      color: #0d6efd;
      text-decoration: none;
    }
    #sourcesDropdown a:hover {
      text-decoration: underline;
    }
    /* Images Container */
    #imagesContainer {
      background: #222325;
      padding: 15px;
      border-radius: 12px;
      width: 75%;
      height: 70vh;
      display: none;
      margin: 10px auto 0; /* Position below the buttons */
      overflow-y: auto;
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 10px;
      height: 100%;
    }
    .image-grid img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .image-grid img:hover {
      transform: scale(1.05);
    }
    /* Input Field & Button */
    #inputContainer { 
      margin-top: 20px; 
      width: 80%;
      display: flex;
      align-items: center;
      gap: 10px;
      background: #444654;
      border-radius: 8px;
      padding: 12px;
    }
    input { 
      flex: 1;
      padding: 14px; 
      font-size: 18px;
      background: transparent;
      border: none;
      color: white;
      outline: none;
    }
    button { 
      background: #0d6efd;
      color: white;
      border: none;
      padding: 14px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
    }
    button:hover {
      background: #0b5ed7;
    }
    /* Close Button */
    #closeButton {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 18px;
      background: #e74c3c;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
    }
    #closeButton:hover {
      background: #c0392b;
    }
    /* Sentiment Analysis Container */
    #sentimentContainer {
      background: #222325;
      padding: 15px;
      border-radius: 12px;
      width: 75%;
      display: none;
      margin: 10px auto 0;
    }
    .graph-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      padding: 10px;
    }
    .graph-container {
      background: #2c2d30;
      padding: 15px;
      border-radius: 8px;
    }
    .graph-container img {
      width: 100%;
      height: auto;
      border-radius: 4px;
    }
    /* Social Analysis Container */
    #socialContainer {
      background: #222325;
      padding: 15px;
      border-radius: 12px;
      width: 75%;
      display: none;
      margin: 10px auto 0;
    }
    .analysis-results {
      background: #2c2d30;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .side-results {
      margin: 15px 0;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .conclusion {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #444;
    }
    .social-analysis {
      background: #222325;
      padding: 25px;
      border-radius: 12px;
      color: white;
    }
    .analysis-content {
      margin-top: 20px;
    }
    .sentiment-section,
    .key-points-section,
    .platform-section {
      background: #2c2d30;
      padding: 20px;
      margin: 15px 0;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .sentiment-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      text-transform: capitalize;
      margin-top: 10px;
      background: #444654;
    }
    .points-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .points-grid li {
      background: #444654;
      padding: 15px;
      border-radius: 8px;
      margin: 0;
      list-style-type: none;
      transition: transform 0.2s ease;
    }
    .points-grid li:hover {
      transform: translateY(-2px);
    }
    .insights-box {
      background: #444654;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
      line-height: 1.6;
    }
    .social-analysis h3 {
      color: #fff;
      font-size: 24px;
      margin-bottom: 20px;
    }
    .social-analysis h4 {
      color: #fff;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .error-message {
      color: #dc3545;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <button id="closeButton" onclick="resetDebate()">Close</button>
  <div id="key">
    <span style="color: #0d6efd;">🔵 For</span>
    <span style="color: #dc3545;">🔴 Against</span>
  </div>
  <h1>OpinionAI</h1>
  <div id="opinionHeader"></div>
  <div id="chatContainer"></div>
  <div id="inputContainer">
    <form onsubmit="submitOpinion(event)" style="display: flex; width: 100%;">
      <input type="text" id="opinionInput" placeholder="Enter your opinion..." required />
      <button type="submit">➤</button>
    </form>
  </div>
</body>
</html>